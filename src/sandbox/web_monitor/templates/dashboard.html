<!--
templates/dashboard.html
-------------------------
UltraMotion IGT â€” Dashboard Professionnel
HÃ´pitaux Universitaires de GenÃ¨ve (HUG)
Laboratoire de CinÃ©siologie
Dashboard temps rÃ©el pour monitoring GPU et pipeline d'infÃ©rence
Les valeurs sont mises Ã  jour via WebSocket (main.js).
-->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UltraMotion IGT | Monitoring Dashboard - HUG Laboratory</title>
    <meta name="description" content="Dashboard de monitoring temps rÃ©el pour systÃ¨mes UltraMotion IGT - Laboratoire de CinÃ©siologie, HÃ´pitaux Universitaires de GenÃ¨ve">
    
    <!-- ðŸŽ¨ ThÃ¨me global et fonts -->
    <link rel="stylesheet" href="/assets/style.css" />
    <link rel="stylesheet" href="/assets/theme_dark.css" />
    <link rel="stylesheet" href="/assets/dashboard-extensions.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- ðŸ”— Favicon et icÃ´nes -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png" />
    <link rel="manifest" href="/assets/site.webmanifest" />
    <meta name="theme-color" content="#0a0e1a" />

    <!-- ðŸ§  Logique WebSocket + DOM -->
    <script type="module" src="/javascript/main.js"></script>
</head>

<body>
    <!-- Navigation principale -->
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="brand-logo">
                <i class="fas fa-heart-pulse"></i>
            </div>
            <div class="brand-text">
                <h1>UltraMotion IGT</h1>
                <span class="brand-subtitle">HÃ´pitaux Universitaires de GenÃ¨ve</span>
            </div>
        </div>
        <div class="nav-status">
            <div class="connection-indicator">
                <div id="connection-status" class="status-dot status-connected"></div>
                <span>Temps rÃ©el</span>
            </div>
            <div class="timestamp" id="current-time">--:--:--</div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar avec rÃ©sumÃ© -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-chart-line"></i> Vue d'ensemble</h3>
            </div>
            
            <div class="overview-card">
                <div class="overview-item">
                    <div class="overview-icon status-ok">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="overview-content">
                        <span class="overview-label">SystÃ¨me</span>
                        <span id="system-health" class="overview-value">OpÃ©rationnel</span>
                    </div>
                </div>
                
                <div class="overview-item">
                    <div class="overview-icon">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div class="overview-content">
                        <span class="overview-label">GPU Load</span>
                        <span id="overview-gpu-util" class="overview-value">0%</span>
                    </div>
                </div>
                
                <div class="overview-item">
                    <div class="overview-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="overview-content">
                        <span class="overview-label">Latence</span>
                        <span id="overview-latency" class="overview-value">-- ms</span>
                    </div>
                </div>
                
                <div class="overview-item">
                    <div class="overview-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="overview-content">
                        <span class="overview-label">Queue</span>
                        <span id="overview-queue" class="overview-value">0</span>
                    </div>
                </div>
            </div>

            <div class="system-info">
                <h4><i class="fas fa-server"></i> Configuration</h4>
                <div class="info-item">
                    <span>Device</span>
                    <span id="sidebar-gpu-device">N/A</span>
                </div>
                <div class="info-item">
                    <span>Driver</span>
                    <span id="sidebar-gpu-driver">N/A</span>
                </div>
                <div class="info-item">
                    <span>Streams</span>
                    <span id="sidebar-gpu-streams">N/A</span>
                </div>
                <div class="info-item">
                    <span>DerniÃ¨re MAJ</span>
                    <span id="sidebar-last-update">-- s</span>
                </div>
            </div>
        </aside>

        <!-- Contenu principal -->
        <main class="main-content">
            <div class="content-header">
                <h2><i class="fas fa-tachometer-alt"></i> Monitoring en Temps RÃ©el</h2>
                <div class="header-actions">
                    <button class="btn btn-secondary" title="Exporter les donnÃ©es">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-primary" title="ParamÃ¨tres du dashboard">
                        <i class="fas fa-cog"></i> ParamÃ¨tres
                    </button>
                </div>
            </div>

            <!-- ==================== MÃ‰TRIQUES ==================== -->
            <div id="metrics" class="metrics-grid">

                <!-- ðŸ“Š PIPELINE PERFORMANCE -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h3><i class="fas fa-route"></i> GPU-RÃ©sident â€” Latence totale</h3>
                        <div class="card-subtitle">RÃ©partition proportionnelle des latences</div>
                    </div>
                    <div class="card-content">
                        <!-- Barre de progression colorÃ©e -->
                        <div class="latency-bar-container">
                            <div class="latency-stages-labels">
                                <span>RXâ†’GPU</span>
                                <span>GPUâ†’PROC</span>
                                <span>PROCâ†’CPU</span>
                                <span>CPUâ†’TX</span>
                            </div>
                            <div class="latency-bar" id="latency-bar">
                                <div class="latency-segment rx-gpu" id="segment-rx-gpu" style="width: 12%" title="RXâ†’GPU"></div>
                                <div class="latency-segment gpu-proc" id="segment-gpu-proc" style="width: 45%" title="GPUâ†’PROC"></div>
                                <div class="latency-segment proc-cpu" id="segment-proc-cpu" style="width: 32%" title="PROCâ†’CPU"></div>
                                <div class="latency-segment cpu-tx" id="segment-cpu-tx" style="width: 11%" title="CPUâ†’TX"></div>
                            </div>
                        </div>
                        
                        <!-- RÃ©sumÃ© compact -->
                        <div class="pipeline-summary-compact">
                            <div class="summary-total">
                                <span>Total RXâ†’TX : </span>
                                <span class="total-value" id="interstage-total">0.0 ms</span>
                                <span class="samples-info">(Frame : <span id="interstage-samples">0</span>)</span>
                            </div>
                            <div class="legend-compact">
                                <span class="legend-item"><span class="legend-color rx-gpu-color"></span> RXâ†’GPU</span>
                                <span class="legend-item"><span class="legend-color gpu-proc-color"></span> GPUâ†’PROC</span>
                                <span class="legend-item"><span class="legend-color proc-cpu-color"></span> PROCâ†’CPU</span>
                                <span class="legend-item"><span class="legend-color cpu-tx-color"></span> CPUâ†’TX</span>
                            </div>
                        </div>
                        
                        <!-- Valeurs dÃ©taillÃ©es avec couleurs -->
                        <div class="latency-details">
                            <div class="detail-item rx-gpu-bg">
                                <span class="detail-label">RXâ†’GPU</span>
                                <span class="detail-value" id="interstage-rx-gpu">0.0 ms</span>
                            </div>
                            <div class="detail-item gpu-proc-bg">
                                <span class="detail-label">GPUâ†’PROC</span>
                                <span class="detail-value" id="interstage-gpu-proc">0.0 ms</span>
                            </div>
                            <div class="detail-item proc-cpu-bg">
                                <span class="detail-label">PROCâ†’CPU</span>
                                <span class="detail-value" id="interstage-proc-cpu">0.0 ms</span>
                            </div>
                            <div class="detail-item cpu-tx-bg">
                                <span class="detail-label">CPUâ†’TX</span>
                                <span class="detail-value" id="interstage-cpu-tx">0.0 ms</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ðŸŽ® GPU PERFORMANCE -->
                <div class="card card-secondary">
                    <div class="card-header">
                        <h3><i class="fas fa-microchip"></i> Performance GPU</h3>
                        <div class="card-subtitle">MÃ©triques de traitement</div>
                    </div>
                    <div class="card-content">
                        <div class="gpu-metrics">
                            <div class="gpu-metric-row">
                                <div class="metric-card">
                                    <div class="metric-icon"><i class="fas fa-images"></i></div>
                                    <div class="metric-info">
                                        <span class="metric-label">Frames</span>
                                        <span id="gpu-frames" class="metric-value">0</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-icon"><i class="fas fa-stopwatch"></i></div>
                                    <div class="metric-info">
                                        <span class="metric-label">Latence moy.</span>
                                        <span id="gpu-avg-lat" class="metric-value">0.0 ms</span>
                                    </div>
                                </div>
                            </div>
                            <div class="gpu-metric-row">
                                <div class="metric-card">
                                    <div class="metric-icon"><i class="fas fa-layer-group"></i></div>
                                    <div class="metric-info">
                                        <span class="metric-label">Norm/Pin/Copy</span>
                                        <span id="gpu-breakdown" class="metric-value">0/0/0</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-icon"><i class="fas fa-tachometer-alt"></i></div>
                                    <div class="metric-info">
                                        <span class="metric-label">Throughput</span>
                                        <span id="gpu-throughput" class="metric-value">0.0 FPS</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ðŸ’» GPU UTILISATION -->
                <div class="card card-accent">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-area"></i> Utilisation GPU</h3>
                        <div class="card-subtitle">Monitoring en temps rÃ©el</div>
                    </div>
                    <div class="card-content">
                        <div class="gpu-utilization">
                            <div class="utilization-main">
                                <div class="utilization-circle">
                                    <svg class="circle-progress" viewBox="0 0 36 36">
                                        <path class="circle-bg" d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831" />
                                        <path id="gpu-util-circle" class="circle-progress-bar" stroke-dasharray="0, 100" d="M18 2.0845
                                            a 15.9155 15.9155 0 0 1 0 31.831
                                            a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    </svg>
                                    <div class="utilization-text">
                                        <span id="gpu-util" class="util-value">0</span>
                                        <span class="util-unit">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="gpu-details">
                                <div class="detail-row">
                                    <span class="detail-label">Device</span>
                                    <span id="gpu-device" class="detail-value">N/A</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Driver / CUDA</span>
                                    <span id="gpu-driver" class="detail-value">N/A</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Streams actifs</span>
                                    <span id="gpu-streams" class="detail-value">N/A</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">MÃ©moire utilisÃ©e</span>
                                    <span id="gpu-memory" class="detail-value">0.0 MB</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">MÃ©moire rÃ©servÃ©e</span>
                                    <span id="gpu-memory-reserved" class="detail-value">0.0 MB</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">DerniÃ¨re MAJ</span>
                                    <span id="gpu-last-update" class="detail-value">-- s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ðŸ“¦ FILES D'ATTENTE -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3><i class="fas fa-layer-group"></i> Files d'attente</h3>
                        <div class="card-subtitle">Gestion des buffers</div>
                    </div>
                    <div class="card-content">
                        <div class="queue-indicators">
                            <div class="queue-item">
                                <div class="queue-icon"><i class="fas fa-clock"></i></div>
                                <div class="queue-info">
                                    <span class="queue-label">Queue RT</span>
                                    <span id="queue-rt" class="queue-value">0</span>
                                </div>
                                <div id="queue-rt-bar" class="queue-bar">
                                    <div class="queue-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="queue-item">
                                <div class="queue-icon"><i class="fas fa-microchip"></i></div>
                                <div class="queue-info">
                                    <span class="queue-label">Queue GPU</span>
                                    <span id="queue-gpu" class="queue-value">0</span>
                                </div>
                                <div id="queue-gpu-bar" class="queue-bar">
                                    <div class="queue-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="queue-item alert">
                                <div class="queue-icon"><i class="fas fa-exclamation-triangle"></i></div>
                                <div class="queue-info">
                                    <span class="queue-label">Drops RT</span>
                                    <span id="queue-drops" class="queue-value">0</span>
                                </div>
                                <div class="queue-indicator"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ðŸ“˜ VALEURS DE RÃ‰FÃ‰RENCE GPU -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3><i class="fas fa-book"></i> Valeurs de RÃ©fÃ©rence</h3>
                        <div class="card-subtitle">Profils de performance GPU</div>
                    </div>
                    <div class="card-content">
                        <div class="reference-table">
                            <div class="ref-header">
                                <span>Ã‰TAPE</span>
                                <span>UTIL (%)</span>
                                <span>MEM. UTIL.</span>
                                <span>MEM. RÃ‰SERVÃ‰E</span>
                            </div>
                            <div class="ref-row">
                                <span class="ref-stage">Idle</span>
                                <span class="ref-util">0â€“2 %</span>
                                <span class="ref-mem">200â€“400 MB</span>
                                <span class="ref-reserved">400â€“600 MB</span>
                            </div>
                            <div class="ref-row">
                                <span class="ref-stage">D-FINE</span>
                                <span class="ref-util">60â€“80 %</span>
                                <span class="ref-mem">600â€“900 MB</span>
                                <span class="ref-reserved">1000â€“1300 MB</span>
                            </div>
                            <div class="ref-row">
                                <span class="ref-stage">MobileSAM</span>
                                <span class="ref-util">80â€“99 %</span>
                                <span class="ref-mem">1000â€“1600 MB</span>
                                <span class="ref-reserved">1800â€“2400 MB</span>
                            </div>
                            <div class="ref-row">
                                <span class="ref-stage">Post-clean</span>
                                <span class="ref-util">5â€“10 %</span>
                                <span class="ref-mem">200â€“400 MB</span>
                                <span class="ref-reserved">400â€“600 MB</span>
                            </div>
                        </div>
                        <div class="ref-note">
                            <i class="fas fa-info-circle"></i>
                            Valeurs typiques RTX 3080/4080 (varient selon GPU)
                        </div>
                    </div>
                </div>

                <!-- ðŸ“ˆ HISTORIQUE ET TENDANCES -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Tendances</h3>
                        <div class="card-subtitle">Historique des performances</div>
                    </div>
                    <div class="card-content">
                        <div class="trends-summary">
                            <div class="trend-item">
                                <div class="trend-icon"><i class="fas fa-arrow-up text-success"></i></div>
                                <div class="trend-info">
                                    <span class="trend-label">Throughput moyen</span>
                                    <span id="trend-throughput" class="trend-value">+12.5%</span>
                                </div>
                            </div>
                            <div class="trend-item">
                                <div class="trend-icon"><i class="fas fa-arrow-down text-success"></i></div>
                                <div class="trend-info">
                                    <span class="trend-label">Latence moyenne</span>
                                    <span id="trend-latency" class="trend-value">-8.3%</span>
                                </div>
                            </div>
                            <div class="trend-item">
                                <div class="trend-icon"><i class="fas fa-minus text-muted"></i></div>
                                <div class="trend-info">
                                    <span class="trend-label">Drops/heure</span>
                                    <span id="trend-drops" class="trend-value">Stable</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- ==================== PIED DE PAGE ==================== -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-left">
                <span class="footer-brand">UltraMotion IGT</span>
                <span class="footer-separator">â€¢</span>
                <span>Laboratoire de CinÃ©siologie, HUG</span>
                <span class="footer-separator">â€¢</span>
                <span class="footer-version">v2.1.0</span>
            </div>
            <div class="footer-right">
                <span>Actualisation: <strong>1s</strong></span>
                <span class="footer-separator">â€¢</span>
                <span id="footer-timestamp">--:--:--</span>
                <span class="footer-separator">â€¢</span>
                <span class="footer-status">
                    <i id="footer-status-icon" class="fas fa-circle text-success"></i>
                    <span id="footer-status-text">ConnectÃ©</span>
                </span>
            </div>
        </div>
    </footer>

    <!-- Scripts additionnels pour les animations et interactions -->
    <script>
        // Mise Ã  jour de l'heure en temps rÃ©el
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('current-time').textContent = timeString;
            document.getElementById('footer-timestamp').textContent = timeString;
        }

        // Animation du cercle de progression GPU
        function animateGPUCircle(percentage) {
            const circle = document.getElementById('gpu-util-circle');
            const circumference = 2 * Math.PI * 15.9155;
            const dashArray = (percentage / 100) * circumference;
            circle.style.strokeDasharray = `${dashArray}, ${circumference}`;
            
            // Couleur dynamique selon l'utilisation
            if (percentage > 90) {
                circle.style.stroke = 'var(--error-color)';
            } else if (percentage > 70) {
                circle.style.stroke = 'var(--warning-color)';
            } else {
                circle.style.stroke = 'var(--accent-color)';
            }
        }

        // Animation des barres de queue
        function animateQueueBar(elementId, value, maxValue = 100) {
            const percentage = Math.min((value / maxValue) * 100, 100);
            const fill = document.querySelector(`#${elementId} .queue-fill`);
            if (fill) {
                fill.style.width = `${percentage}%`;
                
                // Couleur dynamique
                if (percentage > 80) {
                    fill.style.background = 'var(--error-color)';
                } else if (percentage > 60) {
                    fill.style.background = 'var(--warning-color)';
                } else {
                    fill.style.background = 'var(--accent-color)';
                }
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Mise Ã  jour de l'heure toutes les secondes
            updateTimestamp();
            setInterval(updateTimestamp, 1000);
            
            // Animation initiale du cercle GPU
            animateGPUCircle(0);
            
            // Animation d'entrÃ©e progressive des cartes
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
            
            // Gestion des boutons d'action
            document.querySelector('.btn[title="Exporter les donnÃ©es"]').addEventListener('click', function() {
                console.log('Export des donnÃ©es demandÃ©');
                // TODO: ImplÃ©menter l'export
            });
            
            document.querySelector('.btn[title="ParamÃ¨tres du dashboard"]').addEventListener('click', function() {
                console.log('Ouverture des paramÃ¨tres');
                // TODO: ImplÃ©menter les paramÃ¨tres
            });
        });

        // Exposition des fonctions pour les WebSockets
        window.dashboardUtils = {
            animateGPUCircle,
            animateQueueBar,
            updateTimestamp
        };
    </script>
</body>
</html>